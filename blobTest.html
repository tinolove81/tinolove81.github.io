<!DOCTYPE html>
<html>

<head>
    <meta charset='UTF-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no'>
    <link rel='stylesheet' href='./asset/css/bootstrap.min.css' />
    <link rel='icon' href='./favicon.ico' type='image/x-icon'>
    <script src='./asset/js/jquery-3.2.1.min.js'></script>
    <script src='./asset/js/bootstrap.bundle.min.js'></script>
    <title>Goodbye world !</title>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Imprima');
        @import url('https://fonts.googleapis.com/css?family=Noto Sans JP');
        html,
        body {
            font-family: Imprima, 'Noto Sans JP';
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>

<body class='container'>
    <table class='table table-sm table-bordered mt-3'>
        <tbody>
            <tr>
                <td><canvas id='canvasText' class='d-block mx-auto bg-dark'></canvas></td>
                <td><video id='videoLyric' class='d-block mx-auto bg-dark'></video></td>
            </tr>
            <tr>
                <td colspan='2'><video id='audioLyric' class='d-block mx-auto bg-dark'></video></td>
            </tr>
        </tbody>
    </table>
    <div id='myDiv' class=''></div>

    <script>
        let canvas = document.querySelector('#canvasText');
        let ctx = canvas.getContext('2d');
        canvas.width = 480; canvas.height = 50;

        let video = document.querySelector('#videoLyric');
        video.width = 480; video.height = 50;

        let audio = document.querySelector('#audioLyric');
        audio.width = 960; audio.height = 50;

        init();

        function init() {
            video.controls = false;
            video.autoplay = true;
            audio.controls = false;
            audio.autoplay = true;
            audio.ontimeupdate = function () {
                animaLyric(audio.currentTime.toFixed(2));
            };
            audio.src = './asset/lib/Aimer - LAST STARDUST.mp3';
        }

        function animaLyric(mLyric) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.font = '20px Georgia';
            ctx.fillStyle = 'white';
            ctx.fillText(mLyric.toString(), 5, 35);
            ctx.stroke();
            startRecording();
        }

        function startRecording() {
            let chunks = []; // here we will store our recorded media chunks (Blobs)
            let stream = canvas.captureStream(); // grab our canvas MediaStream
            let rec = new MediaRecorder(stream); // init the recorder
            // every time the recorder has new data, we will store it in our array
            rec.ondataavailable = (e) => chunks.push(e.data);
            rec.onstop = (e) => exportVid(new Blob(chunks, { type: 'video/webm' }));
            rec.start();
            setTimeout(() => rec.stop(), 50); // stop recording in 3s
        }

        function exportVid(blob) {
            video.src = URL.createObjectURL(blob);
            video.controls = false;
            video.autoplay = true;
        }

        let x = 0;
        function canvasAnima() {
            x = (x + 1) % canvas.width;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            ctx.strokeStyle = 'black';
            ctx.lineWidth = '5';
            ctx.arc(50 + x, 50, 46, 0, Math.PI*2, false);
            ctx.stroke();
            ctx.strokeStyle = 'red';
            ctx.lineWidth = '2.5';
            ctx.arc(50 + x, 50, 46, 0, Math.PI*2, false);
            ctx.stroke();
            if (x !== (canvas.width - 1)) requestAnimationFrame(canvasAnima);
        }
    // https://stackoverflow.com/questions/50681683/how-to-save-canvas-animation-as-gif-or-webm
    </script>
    <!-- script>
    // Data to Blob
        let blob = new Blob(['Array', 'Blob', 'DOMString'], {type: 'text/csv;charset=utf-8;'});
    // Blob to Object URL
        let filename = 'ArrayOrBlob.csv';
        if (navigator.msSaveBlob) { // IE 10+
            navigator.msSaveBlob(blob, filename);
        } else {
            // FF need real DOM to trigger
            // let link = document.querySelector('#QuerypageInputBtn03'); 
            let link = document.createElement('a'); 
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('target', '_blank');
            link.setAttribute('download', filename);
            link.click();
        }

    /* 拆包
        var blobUrl = document.querySelector('video').src;
        var data, blobUrl;
        var URL_o = Object.assign({}, URL);
        URL = {
            'createObjectURL': function (e) {
                console.log('createObjectURL: #START###############################################');
                console.log(e);
                console.log('createObjectURL: #END#################################################');
                data = e;
                blobUrl = URL_o.createObjectURL(e);
                return blobUrl;
            },
            'revokeObjectURL': function (e) {
                console.log('revokeObjectURL: #START###############################################');
                console.log(e);
                console.log('revokeObjectURL: #END#################################################');
            }
        }

        var setTimeout_o = setTimeout;
        setTimeout=(f, t)=>{if(t>2000)console.log(f, t);setTimeout_o(f, t);}

        _yt_player.Vo.getInstance()??
        _yt_player.E=()=>{return 2599999999999;}
    */


    // Get Data from Blob
        let reader = new FileReader();
        reader.addEventListener('loadend', function() {
            base64data = reader.result;                
            console.log(base64data);
        });
        reader.readAsArrayBuffer(blob);

    // Get Blob from Object URL
function b() {
    let blobUrl = document.querySelector('video').src;
    let xhr = new XMLHttpRequest();
    xhr.open('GET', blobUrl);
    xhr.responseType = 'blob';
    xhr.onload = function(e) {
        if (this.status == 200) {
            var myBlob = this.response;
            console.log(myBlob);
        }
    };
    xhr.send();
}

/*
    (fx=()=>{
        var gm = (window.yt && window.yt.config_ || window.ytcfg && window.ytcfg.data_)['EXPERIMENT_FLAGS'];
        var m = `### Youtube Config Test ###\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n`;
            m += ` window['_lact'] = ${window['_lact']}  (${new Date(window['_lact']).toLocaleString()})\t\t\t\t\t\t\n`;
            m += ` window['_fact'] = ${window['_fact']}\t\t\t\t\t\t\t\t\t\t\t\t\n`;
            m += ` Last activity pass: ${new Date(+new Date-window['_lact']).toISOString().substr(11, 8)}\t\t\t\t\t\t\t\t\t\t\t\t\t\n`;
            m += ` gm['user_engagement_enable_autoplay_pause_feature']: ${gm['user_engagement_enable_autoplay_pause_feature']}\t\t\t\t\t\n`;
            m += ` gm['is_part_of_any_user_engagement_experiment']: ${gm['is_part_of_any_user_engagement_experiment']}\t\t\t\t\t\t\t\n`;
            m += ` gm['enable_watch_next_pause_autoplay_lact']: ${gm['enable_watch_next_pause_autoplay_lact']}\t\t\t\t\t\t\t\t\n`;
            m += ` gm['watch_next_pause_autoplay_lact_sec']: ${gm['watch_next_pause_autoplay_lact_sec']} (s)\t\t\t\t\t\t\t\t\n`;
            m += ` gm['autoplay_pause_by_lact_sec']: ${gm['autoplay_pause_by_lact_sec']} (s)\t\t\t\t\t\t\t\t\t\t\n`;

            m += ` Next expected pause time: ${new Date(window['_lact']+gm['watch_next_pause_autoplay_lact_sec']*1E3).toLocaleString()}\t\t\t\t\t\t\t\t\n`;
        console.log('%c'+m, 'background:#222;color:#CFA');
    })()

    enable_autoplay_pause_by_lact

    new Date(window["_lact"])
    gm = (window.yt && window.yt.config_ || window.ytcfg && window.ytcfg.data_)['EXPERIMENT_FLAGS'];

    gm["user_engagement_enable_autoplay_pause_feature"]
    gm["is_part_of_any_user_engagement_experiment"]
    gm["enable_watch_next_pause_autoplay_lact"]
    gm["watch_next_pause_autoplay_lact_sec"]

    gm["autoplay_pause_by_lact_sec"]

    _yt_player.M.prototype.Tu()
*/
    </script -->
</body>

</html>
